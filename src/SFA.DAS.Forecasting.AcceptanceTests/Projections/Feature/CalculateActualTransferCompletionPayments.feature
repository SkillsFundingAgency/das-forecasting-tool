Feature: Calculate actual transfer completion payments (CI-620)
	As an employer
	I want to see my actual training completion costs for transfers that I'm funding
	So that they can be taken into account while forecasting against my transfer allowance

Background:
	Given I'm a levy paying employer
	And the payroll period is 
	| Payroll Year | Payroll Month |
	| 18-19        | 1             |
	And the following levy declarations have been recorded
	| Scheme   | Amount | Created Date |
	| ABC-1234 | 3000   | Today        |
	And the current balance is 5000

Scenario: AC1: Multiple transfer commitments
	Given the following commitments have been recorded
	| Apprentice Name   | Course Name   | Course Level | Provider Name   | Start Date | Installment Amount | Completion Amount | Number Of Installments | EmployerAccountId | SendingEmployerAccountId | FundingSource |
	| Test Apprentice   | Test Course   | 1            | Test Provider 1 | Yesterday  | 2000               | 1200              | 6                      | 999               | 12345                    | Transfer      |
	| Test Apprentice 1 | Test Course   | 1            | Test Provider 2 | Yesterday  | 2000               | 1200              | 6                      | 999               | 12345                    | Transfer      |
	| Test Apprentice 2 | Test Course 2 | 1            | Test Provider 3 | Yesterday  | 2000               | 1200              | 6                      | 999               | 12345                    | Transfer      |
	| Test Apprentice 3 | Test Course   | 1            | Test Provider 4 | Yesterday  | 2000               | 1200              | 6                      | 999               | 12345                    | Transfer      |
	| Test Apprentice 4 | Test Course 2 | 1            | Test Provider 5 | Next Year  | 2000               | 1200              | 6                      | 999               | 12345                    | Transfer      |

	When the account projection is triggered after a payment run
	Then the account projection should be generated	
	And should have following projections from completion
	| MonthsFromNow | EmployerAccountId | ProjectionCreationDate  | ProjectionGenerationType | FundsIn | TotalCostOfTraining | TransferOutTotalCostOfTraining | TransferInTotalCostOfTraining | TransferInCompletionPayments | CompletionPayments | TransferOutCompletionPayments | FutureFunds | CoInvestmentEmployer | CoInvestmentGovernment |
	| 0             | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 8000.00     | 0.00                 | 0.00                   |
	| 1             | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 8000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 3000.00     | 0.00                 | 0.00                   |
	| 2             | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 8000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 0.00        | 200.00               | 1800.00                |
	| 3             | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 8000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 0.00        | 500.00               | 4500.00                |
	| 4             | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 8000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 0.00        | 500.00               | 4500.00                |
	| 5             | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 8000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 0.00        | 500.00               | 4500.00                |
	| 6             | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 8000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 0.00        | 500.00               | 4500.00                |
	| 7             | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 4800.00                       | 0.00        | 180.00               | 1620.00                |
	| 8             | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 3000.00     | 0.00                 | 0.00                   |
	| 9             | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 6000.00     | 0.00                 | 0.00                   |
	| 10            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 9000.00     | 0.00                 | 0.00                   |
	| 11            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 12000.00    | 0.00                 | 0.00                   |
	| 12            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 15000.00    | 0.00                 | 0.00                   |
	| 13            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 2000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 16000.00    | 0.00                 | 0.00                   |
	| 14            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 2000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 17000.00    | 0.00                 | 0.00                   |
	| 15            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 2000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 18000.00    | 0.00                 | 0.00                   |
	| 16            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 2000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 19000.00    | 0.00                 | 0.00                   |
	| 17            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 2000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 20000.00    | 0.00                 | 0.00                   |
	| 18            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 2000.00                        | 0.00                          | 0.00                         | 0.00               | 0.00                          | 21000.00    | 0.00                 | 0.00                   |
	| 19            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 1200.00                       | 22800.00    | 0.00                 | 0.00                   |
	| 20            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 25800.00    | 0.00                 | 0.00                   |
	| 21            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 28800.00    | 0.00                 | 0.00                   |
	| 22            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 31800.00    | 0.00                 | 0.00                   |
	| 23            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 34800.00    | 0.00                 | 0.00                   |
	| 24            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 37800.00    | 0.00                 | 0.00                   |
	| 25            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 40800.00    | 0.00                 | 0.00                   |
	| 26            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 43800.00    | 0.00                 | 0.00                   |
	| 27            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 46800.00    | 0.00                 | 0.00                   |
	| 28            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 49800.00    | 0.00                 | 0.00                   |
	| 29            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 52800.00    | 0.00                 | 0.00                   |
	| 30            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 55800.00    | 0.00                 | 0.00                   |
	| 31            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 58800.00    | 0.00                 | 0.00                   |
	| 32            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 61800.00    | 0.00                 | 0.00                   |
	| 33            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 64800.00    | 0.00                 | 0.00                   |
	| 34            | 12345             | 2018-05-16 08:08:14.447 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 67800.00    | 0.00                 | 0.00                   |
	| 35            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 70800.00    | 0.00                 | 0.00                   |
	| 36            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 73800.00    | 0.00                 | 0.00                   |
	| 37            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 76800.00    | 0.00                 | 0.00                   |
	| 38            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 79800.00    | 0.00                 | 0.00                   |
	| 39            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 82800.00    | 0.00                 | 0.00                   |
	| 40            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 85800.00    | 0.00                 | 0.00                   |
	| 41            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 88800.00    | 0.00                 | 0.00                   |
	| 42            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 91800.00    | 0.00                 | 0.00                   |
	| 43            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 94800.00    | 0.00                 | 0.00                   |
	| 44            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 97800.00    | 0.00                 | 0.00                   |
	| 45            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 100800.00   | 0.00                 | 0.00                   |
	| 46            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 103800.00   | 0.00                 | 0.00                   |
	| 47            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 106800.00   | 0.00                 | 0.00                   |
	| 48            | 12345             | 2018-05-16 08:08:14.450 | 1                        | 3000.00 | 0.00                | 0.00                           | 0.00                          | 0.00                         | 0.00               | 0.00                          | 109800.00   | 0.00                 | 0.00                   |

Scenario: AC3: Multiple transfer commitments and some with end dates after end of forecast period
	Given the following commitments have been recorded
	| Apprentice Name   | Course Name   | Course Level | Provider Name   | Start Date | Installment Amount | Completion Amount | Number Of Installments | EmployerAccountId | SendingEmployerAccountId | FundingSource |
	| Test Apprentice   | Test Course   | 1            | Test Provider 1 | Today      | 2000               | 1200              | 48                     | 999               | 12345                    | Transfer      |
	| Test Apprentice 4 | Test Course 2 | 1            | Test Provider 5 | Today      | 2000               | 1200              | 48                     | 999               | 12345                    | Transfer      |

	When the account projection is triggered after a payment run
	Then the account projection should be generated
	And should have no payments with TransferOutCompletionPayments